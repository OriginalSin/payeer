# payeer

Изменение баланса не зависит от истории операций!

Оно зависит только от bestAsk (это самая нижня цена в верхнем стакане) и bestBid (самая верхняя цена в нижнем стакане).

Действительно, если в истории операций есть какая-то верхняя строка, то она отражает последнюю завершенную операцию.

После этой операции цены продажи и покупки на будущее уже определяются значениями bestAsk, bestBid,
и никак не зависят от завершенной операции и ее цены.

Баланс меняется только из-за наличия крипты в портфеле и только по двум причинам:

1) в момент покупки мы теряем на разнице курсов покупки и продажи

2) изменение курса продажи (bestBid нижнего стакана)

Новый алгоритм

В нем три пункта.

1. Оптимальный момент покупки крипты

Операция покупки приводит к следующему изменению баланса 
(мы считаем для простоты, что покупка происходит мгновенно, т.е. количество покупаемой крипты не больше, чем в строке bestAsk)

Balance * Bid / Ask,

где Bid и Ask - это лучшие цены bestBid и bestAsk в стакане на момент покупки.

Коэффициент потери Bid/Ask (который всегда меньше единицы) надо выбирать так, чтобы он был максимален.

Поэтому делаем предсказание nextBid и nextAsk (используя линейную интерполяцию или сплайны, или еще как-то).

Покупку делаем, если

1) nextBid/nextAsk < Bid/Ask 
(т.е. коэффициент уменьшится, станет хуже, 
если мы купим не сейчас, а на следующем шаге изменения стаканов)

2) nextBid > Bid
(т.е. ожидается рост цены продажи - в верхней строчки нижнего стакана)

Запоминаем цену покупки в переменной lastBid.

Сразу после покупки выставляем ордер StopLoss (см. ниже).

2. Момент продажи крипты ввиду достижения нужного дохода (TakeProfit)

Устанавливаем для себя критерий, когда мы фиксируем прибыль. Например, 3%. 

Выставляем ордер на продажу 100% крипты по цене LastBid * 1.03

Пока цена Bid в стакане меньше, ордер ждет выполнения. При достижении этой цены ордер автоматически срабатывает.

3. Момент продажи валюты ввиду достижения уровня убтка (StopLoss)

Устанавливаем для себя критерий, когда мы останавливаем убыток. Например, -2%. 

Выставляем ордер на покупку 100% крипты по цене lastBid * 0.98

Пока цена Bid в стакане больше, ордер ждет выполнения. При достижении этой цены ордер автоматически срабатывает.

4. Общая логика работы алгоритма:

Покупаем крипту в нужный момент (когда Bid растет, а Bid/Ask убывает)

Сразу выставляем StopLoss.

Отслеживаем изменение цены Bid в нижнем стакане.

Если Bid вырос и установлен StopLoss, отменяем его и ставим TakeProfit.

Если Bid вырос и не установлен StopLoss, продолжаем держать TakeProfit (если его нет, устанавливаем его).

Если Bid упал и Bid > lastBid * 0.99, ничего не делаем (т.е. держим ордер TakeProfit)

Если Bid упал и lastBid * 0.98 < Bid < lastBid * 0.99, устанавливаем StopLoss

Если Bid упал и Bid < lastBid * 0.98, устанавливаем StopLoss по текущей цене Bid (т.е. немедленно продаем крипту)
